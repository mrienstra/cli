{{> release}}

  smoke-publish:
    {{> setupJobMatrix checkout=(obj ref="${{ inputs.ref }}")}}
      - name: Pack
        run: |
          NPM_VERSION="$(node bin/npm-cli.js --version)-$GITHUB_SHA.0"
          node bin/npm-cli.js version $NPM_VERSION --ignore-scripts
          node bin/npm-cli.js run resetdeps
          git clean -fd
          node bin/npm-cli.js ls --production >/dev/null
          node bin/npm-cli.js prune --production --no-save --no-audit --no-fund
          node scripts/git-dirty.js
          node bin/npm-cli.js pack --pack-destination=$RUNNER_TEMP
          node bin/npm-cli.js install -g $RUNNER_TEMP/npm-$NPM_VERSION.tgz
          node bin/npm-cli.js install -w smoke-tests --ignore-scripts --no-audit --no-fund
          rm -rf {lib,bin,index.js}
          SMOKE_PUBLISH_NPM=1 npm test -w smoke-tests --ignore-scripts
          
